pipeline{
    agent any

    parameters{
        booleanParam(name:'init_tf', defaultValue:true)
        booleanParam(name:'plan_tf', defaultValue:true)
        booleanParam(name:'apply_tf', defaultValue:true)
        booleanParam(name:'destroy_tf', defaultValue:true)
    }

    stages{

        stage('Git Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/vasanth129/terraform-practice.git'
            }
        }

        stage('Terraform Init'){
            when {
                expression{ params.init_tf }
            }

            steps{
                dir("day-2-tfvars"){
                    sh "terraform init"
                }
            }
        }

        stage('Terraform Plan'){
            when {
                expression{ params.plan_tf }
            }

            steps{
                dir("day-2-tfvars"){
                    sh "terraform plan"
                }
            }
        }

        stage('Validate Apply and Destroy'){
	        steps{
		        script {
			        if(params.destroy_tf && params.apply_tf){
				        error 'Connot run terraform apply and destroy in the same build'
			        }
                    else{
                        echo "Apply and Destroy Validation pass, skipping..."
                    }
		        }
	        }
        }

        stage('Approval'){
            steps{
                script{
                    if(params.destroy_tf || params.apply_tf){
                        input message : "Approve Terraform Apply/Destroy?"
                    }
                    else{
                        echo "no approval needed, skipping.."
                    }
                }
            }
        }

        stage('Terraform Apply'){
            when {
                expression{ params.apply_tf }
            }

            steps{
                dir("day-2-tfvars"){
                    sh "terraform apply -auto-approve"
                }
            }
        }

        stage('Terraform Destroy'){
            when {
                expression{ params.destroy_tf }
            }

            steps{
                dir("day-2-tfvars"){
                    sh "terraform destroy -auto-approve"
                }
            }
        }
    }
}
